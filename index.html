<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LIFF Sample</title>

    <!-- LIFF SDK（固定版） -->
    <script src="https://static.line-scdn.net/liff/edge/versions/2.22.3/sdk.js"></script>

    <style>
      :root{
        --bg: #0b0f19;
        --card: rgba(255,255,255,.06);
        --card2: rgba(255,255,255,.08);
        --text: rgba(255,255,255,.92);
        --muted: rgba(255,255,255,.68);
        --line: rgba(255,255,255,.12);
        --accent: #22c55e; /* green */
        --accent2: #60a5fa; /* blue */
        --danger: #ef4444;
        --shadow: 0 10px 30px rgba(0,0,0,.35);
        --radius: 16px;
      }
      @media (prefers-color-scheme: light){
        :root{
          --bg: #f7f7fb;
          --card: rgba(0,0,0,.04);
          --card2: rgba(0,0,0,.06);
          --text: rgba(0,0,0,.88);
          --muted: rgba(0,0,0,.60);
          --line: rgba(0,0,0,.10);
          --shadow: 0 10px 30px rgba(0,0,0,.10);
        }
      }

      * { box-sizing: border-box; }
      body{
        margin:0;
        font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Sans", "Helvetica Neue", Arial, sans-serif;
        color: var(--text);
        background:
          radial-gradient(1200px 600px at 20% -10%, rgba(34,197,94,.25), transparent 55%),
          radial-gradient(900px 500px at 100% 10%, rgba(96,165,250,.22), transparent 55%),
          var(--bg);
        min-height: 100vh;
        padding: 20px;
      }

      .wrap{
        max-width: 920px;
        margin: 0 auto;
        display: grid;
        gap: 16px;
      }

      .hero{
        padding: 18px 18px 14px;
        border: 1px solid var(--line);
        border-radius: var(--radius);
        background: linear-gradient(180deg, var(--card), transparent);
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
      }

      .title{
        display:flex;
        align-items:center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 10px;
      }
      h1{
        font-size: 20px;
        line-height: 1.2;
        margin:0;
        letter-spacing: .2px;
      }

      /* ★追加：LIFF URLリンクの見た目 */
      .liff-link{
        display: inline-block;
        margin-top: 4px;
        font-size: 12px;
        color: var(--accent2);
        text-decoration: none;
        opacity: .9;
      }
      .liff-link:hover{
        text-decoration: underline;
        opacity: 1;
      }

      .badge{
        display:inline-flex;
        align-items:center;
        gap: 8px;
        padding: 8px 10px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: var(--card2);
        color: var(--muted);
        font-size: 12px;
        white-space: nowrap;
      }
      .dot{
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: var(--muted);
      }
      .dot.ok{ background: var(--accent); }
      .dot.ng{ background: var(--danger); }

      .sub{
        margin: 0;
        color: var(--muted);
        font-size: 13px;
        line-height: 1.5;
      }

      .grid{
        display:grid;
        grid-template-columns: 1.2fr .8fr;
        gap: 16px;
      }
      @media (max-width: 860px){
        .grid{ grid-template-columns: 1fr; }
      }

      .card{
        border: 1px solid var(--line);
        border-radius: var(--radius);
        background: var(--card);
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
        overflow: hidden;
      }
      .card-h{
        padding: 14px 16px;
        border-bottom: 1px solid var(--line);
        display:flex;
        align-items:center;
        justify-content: space-between;
        gap: 10px;
      }
      .card-h .h{
        font-size: 14px;
        margin:0;
        color: var(--text);
        letter-spacing: .2px;
      }
      .card-b{
        padding: 14px 16px 16px;
      }

      .warn{
        margin: 8px 0 0;
        color: #ffb4b4;
        font-size: 12px;
      }
      @media (prefers-color-scheme: light){
        .warn{ color:#b00020; }
      }

      .btns{
        display:flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      button{
        appearance: none;
        border: 1px solid var(--line);
        background: rgba(255,255,255,.06);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 12px;
        font-size: 13px;
        cursor: pointer;
        transition: transform .06s ease, background .2s ease, border-color .2s ease;
      }
      button:hover{ background: rgba(255,255,255,.10); }
      button:active{ transform: translateY(1px); }
      button.primary{
        border-color: rgba(34,197,94,.55);
        background: rgba(34,197,94,.15);
      }
      button.primary:hover{ background: rgba(34,197,94,.22); }
      button.info{
        border-color: rgba(96,165,250,.55);
        background: rgba(96,165,250,.15);
      }
      button.info:hover{ background: rgba(96,165,250,.22); }
      button.ghost{
        background: transparent;
      }

      .kv{
        display:grid;
        grid-template-columns: 160px 1fr;
        gap: 10px 12px;
        margin: 0;
        font-size: 13px;
        color: var(--muted);
      }
      .kv dt{ color: var(--muted); }
      .kv dd{ margin:0; color: var(--text); overflow-wrap:anywhere; }

      pre{
        margin:0;
        padding: 14px 16px;
        border-top: 1px solid var(--line);
        background: rgba(0,0,0,.18);
        color: rgba(255,255,255,.86);
        overflow:auto;
        font-size: 12px;
        line-height: 1.5;
      }
      @media (prefers-color-scheme: light){
        pre{
          background: rgba(0,0,0,.04);
          color: rgba(0,0,0,.80);
        }
      }

      .tiny{
        font-size: 12px;
        color: var(--muted);
        margin-top: 10px;
        line-height: 1.5;
      }
      code.k{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    </style>
  </head>

  <body>
    <div class="wrap">
      <section class="hero">
        <div class="title">
          <div>
            <h1>LIFF Sample</h1>
            <a
              href="https://liff.line.me/1657551101-OLp9pM2g"
              target="_blank"
              rel="noopener noreferrer"
              class="liff-link"
            >
              LIFF URL を開く →
            </a>
          </div>

          <div class="badge" id="badge">
            <span class="dot" id="dot"></span>
            <span id="statusText">Initializing…</span>
          </div>
        </div>

        <p class="sub">
          目的：<b>ログイン確認</b>／<b>プロフィール取得</b>／<b>FLEXメッセージ送信</b>（<code class="k">sendMessages → shareTargetPicker</code> フォールバック）
        </p>
        <p class="warn" id="warn"></p>
      </section>

      <section class="grid">
        <div class="card">
          <div class="card-h">
            <p class="h">操作</p>
            <div class="badge">
              <span>LIFF ID:</span>
              <code class="k" id="liffIdText">-</code>
            </div>
          </div>
          <div class="card-b">
            <div class="btns">
              <button class="info" id="btnLogin">login</button>
              <button id="btnProfile">getProfile</button>
              <button class="ghost" id="btnLogout">logout</button>
              <button class="primary" id="btnRandomFlex">ランダム一言をFLEXで送る</button>
            </div>
            <p class="tiny">
              <b>sendMessages</b> は「トーク起点 + 権限（スコープ）」が必要な場合があり、ダメなら自動で <b>shareTargetPicker</b> に切り替えます。
            </p>
          </div>
          <pre id="out">{}</pre>
        </div>

        <div class="card">
          <div class="card-h">
            <p class="h">状態</p>
            <button class="ghost" id="btnRefresh">再表示</button>
          </div>
          <div class="card-b">
            <dl class="kv">
              <dt>inClient</dt><dd id="kvInClient">-</dd>
              <dt>loggedIn</dt><dd id="kvLoggedIn">-</dd>
              <dt>context</dt><dd id="kvContext">-</dd>
            </dl>
            <p class="tiny">
              送信がうまくいかないときは、<b>LINEアプリ内</b>で起動しているか（inClient）と、<b>ログイン状態</b>（loggedIn）をまず確認。
            </p>
          </div>
        </div>
      </section>
    </div>

    <script>
      // あなたの LIFF ID
      const LIFF_ID = "1657551101-OLp9pM2g";

      // ランダム文言（10個）
      const RANDOM_MESSAGES = [
        "やほー！元気ー？",
        "今ひまー？",
        "なにしてるのー？",
        "ちょっとだけ話さない？",
        "おつかれさまー",
        "今日どうだった？",
        "なんとなく連絡してみた",
        "暇つぶしに送ってみた笑",
        "元気そうでなにより！",
        "今ちょっと思い出した！"
      ];

      const elWarn = document.getElementById("warn");
      const elOut = document.getElementById("out");

      const elDot = document.getElementById("dot");
      const elStatusText = document.getElementById("statusText");

      const elKvInClient = document.getElementById("kvInClient");
      const elKvLoggedIn = document.getElementById("kvLoggedIn");
      const elKvContext = document.getElementById("kvContext");
      const elLiffIdText = document.getElementById("liffIdText");

      function log(obj) {
        elOut.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
      }

      function setStatus(ok, text) {
        elStatusText.textContent = text;
        elDot.classList.remove("ok", "ng");
        if (ok === true) elDot.classList.add("ok");
        if (ok === false) elDot.classList.add("ng");
      }

      function pickRandomMessage() {
        const i = Math.floor(Math.random() * RANDOM_MESSAGES.length);
        return RANDOM_MESSAGES[i];
      }

      function buildFlexMessage(text) {
        return {
          type: "flex",
          altText: text,
          contents: {
            type: "bubble",
            size: "mega",
            body: {
              type: "box",
              layout: "vertical",
              spacing: "md",
              contents: [
                { type: "text", text: "Random ping", size: "sm", color: "#A3A3A3" },
                { type: "text", text, size: "xl", weight: "bold", wrap: true, color: "#111827" },
                {
                  type: "box",
                  layout: "baseline",
                  spacing: "sm",
                  contents: [
                    { type: "text", text: "from LIFF", size: "sm", color: "#6B7280", flex: 0 },
                    { type: "text", text: new Date().toLocaleString(), size: "sm", color: "#9CA3AF", wrap: true }
                  ]
                }
              ]
            },
            styles: { body: { backgroundColor: "#FFFFFF" } }
          }
        };
      }

      function refreshKVs() {
        try {
          const inClient = liff.isInClient();
          const loggedIn = liff.isLoggedIn();
          const context = liff.getContext ? liff.getContext() : null;

          elKvInClient.textContent = String(inClient);
          elKvLoggedIn.textContent = String(loggedIn);
          elKvContext.textContent = context ? JSON.stringify(context) : "-";

          if (!loggedIn) {
            elWarn.textContent = "未ログインです。外部ブラウザで開いている場合は login を押してください。";
          } else {
            elWarn.textContent = "";
          }

          log({ liffId: LIFF_ID, inClient, loggedIn, context });
        } catch (e) {}
      }

      async function trySendFlex() {
        const text = pickRandomMessage();
        const messages = [buildFlexMessage(text)];

        try {
          await liff.sendMessages(messages);
          log({ sentBy: "sendMessages", message: "FLEX sent", text });
          liff.closeWindow();
          return;
        } catch (err) {
          log({
            note: "sendMessages 失敗 → shareTargetPicker にフォールバック",
            sendMessagesError: err?.message || String(err),
            text
          });
        }

        if (!liff.isLoggedIn()) {
          elWarn.textContent = "shareTargetPicker を使うため login が必要です。login します。";
          liff.login({ redirectUri: window.location.href });
          return;
        }

        try {
          await liff.shareTargetPicker(messages, { isMultiple: true });
          log({ sentBy: "shareTargetPicker", message: "FLEX opened", text });
        } catch (err) {
          log({ where: "shareTargetPicker", error: err?.message || String(err) });
        }
      }

      async function main() {
        elLiffIdText.textContent = LIFF_ID;

        try {
          await liff.init({ liffId: LIFF_ID });

          setStatus(true, "Ready");
          refreshKVs();

          document.getElementById("btnRefresh").addEventListener("click", refreshKVs);

          document.getElementById("btnLogin").addEventListener("click", () => {
            if (!liff.isLoggedIn()) liff.login({ redirectUri: window.location.href });
          });

          document.getElementById("btnProfile").addEventListener("click", async () => {
            try {
              if (!liff.isLoggedIn()) {
                elWarn.textContent = "先に login が必要です。";
                return;
              }
              const profile = await liff.getProfile();
              log(profile);
            } catch (e) {
              log({ where: "getProfile", error: String(e) });
            }
          });

          document.getElementById("btnLogout").addEventListener("click", () => {
            if (liff.isLoggedIn()) liff.logout();
            window.location.reload();
          });

          document.getElementById("btnRandomFlex").addEventListener("click", async () => {
            elWarn.textContent = "";
            await trySendFlex();
          });

        } catch (err) {
          setStatus(false, "LIFF init failed");
          log({
            error: err?.message || String(err),
            checklist: [
              "Endpoint URL がこのページのURLと一致しているか",
              "HTTPSで配信しているか",
              "LIFF ID が正しいか",
              "テスト対象者（権限）に起動ユーザーが含まれているか",
              "Share Target Picker を使う場合、コンソール側で有効化しているか"
            ]
          });
        }
      }

      main();
    </script>
  </body>
</html>
